<!doctype html>
<html>
<head><meta charset="utf-8"/>
<title>TextGUI</title>
<style>
body {
	background-color: black;
	margin: 0;
	overflow: hidden;
}
canvas {
}
</style>
</head>
<body>
<canvas/>
<script>
function $(selector) { return document.querySelector(selector) }
let canvas = $("canvas");
let ctx = canvas.getContext("2d");

function x(i) { return canvas.MX + i * canvas.TX }
function y(j) { return canvas.MY + j * canvas.TY }

class View {
	constructor(parent) {
		this.left = 0;
		this.top = 0;
		this.width = 10;
		this.height = 4;

		this.parent = parent;
		this.children = [];
		if (parent) parent.children.push(this);

		this.decorators = [];
	}

	position(i, j) {
		this.left = i;
		this.top = j;
		return this;
	}

	size(w, h) {
		this.width = w;
		this.height = h;
		return this;
	}

	i(i) { return (i||0) + this.left + (this.parent ? this.parent.i(0) : 0) }
	j(j) { return (j||0) + this.top  + (this.parent ? this.parent.j(0) : 0) }
	x(i) { return x(this.i(i)) }
	y(j) { return y(this.j(j)) }
	get w() { return this.width * canvas.TX }
	get h() { return this.height * canvas.TY }
	get x0() { return this.x(0) }
	get y0() { return this.y(0) }
	get x1() { return this.x(this.width) - canvas.PX }
	get y1() { return this.y(this.height) - canvas.PY }

	putc(c, i, j) { putc(c, this.i(i), this.j(j)) }

	draw() {
		if (this.backgroundColor) {
			ctx.fillStyle = this.backgroundColor;
			ctx.fillRect(this.x0, this.y0, this.w, this.h);
		}
		this.decorators.map(x => { if (x.draw) x.draw(this) });
		this.children.map(c => c.draw());
	}

	cascade(attrib) { return (!this.parent ||  typeof this[attrib] != "undefined") ?
		this[attrib] : this.parent.cascade(attrib); }
}

let TITLE_DECOR = {
	draw: view => {
		if (view.title) {
			ctx.fillStyle = view.cascade("color") || "black";
			view.putc("☰", 0, 0);
			for (let i = 0; i < view.title.length; ++i) {
				if (i >= view.width - 4) break;
				view.putc(view.title.charAt(i), i + 2, 0);
			}
			view.putc("×", view.width - 1, 0);
			ctx.fillRect(view.x0, view.y(1), view.w, canvas.PY);
		}
	}
};

function makeTitle(parent, title) {
	let titlebar = new View(parent).size(parent.width, 1);
	titlebar.title = title;
	titlebar.decorators.push(TITLE_DECOR);
}

let WINDOW = new View().size(15, 8).position(10, 10);
WINDOW.backgroundColor = randColor(0.8);
makeTitle(WINDOW, "Window 3");

function putc(c, i, j, color) {
	// ctx.fillStyle = color;
	ctx.fillText(c, canvas.MX + i * canvas.TX, canvas.MY + (j+1) * canvas.TY - 3);
}

function random(x, y, z) {
	return Math.abs(Math.sin((x||0) * 8872.2831 + (y||0) * 1258.9823 + (z||0) * 5982.1225) * 89237.9578) % 1;
}

function hsv2rgb(h, s, v) {
  var r, g, b;

  var i = Math.floor(h * 6);
  var f = h * 6 - i;
  var p = v * (1 - s);
  var q = v * (1 - f * s);
  var t = v * (1 - (1 - f) * s);

  switch (i % 6) {
    case 0: r = v, g = t, b = p; break;
    case 1: r = q, g = v, b = p; break;
    case 2: r = p, g = v, b = t; break;
    case 3: r = p, g = q, b = v; break;
    case 4: r = t, g = p, b = v; break;
    case 5: r = v, g = p, b = q; break;
  }

  return [r,g,b].map(c => Math.floor(c * 256));
}

function randColor(v) {
	let rgb = hsv2rgb(Math.random(), Math.random(), v);
	return `rgb(${rgb.join(",")})`;
}

function rgb(rgb) {
	return `rgb(${rgb.join(",")})`;
}

function resize() {
	canvas.width = window.innerWidth;
	canvas.height = window.innerHeight;
	let F = 20;
	ctx.font = `${F}px Inconsolata, monospace`;
	let W = canvas.TX = ctx.measureText("X").width + 1;  // 11
	canvas.TY = F;
	canvas.NX = Math.floor(canvas.width  / W);
	canvas.NY = Math.floor(canvas.height / F);
	canvas.PX = 1;///W;
	canvas.PY = 1;///F;
	// ctx.scale(W, F);
	canvas.MX = 2 * canvas.PX;
	canvas.MY = 0;
	draw();
}

function draw() {
	let alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
	alphabet += alphabet.toLowerCase();
	alphabet += "0123456789";
	alphabet += "~!@#$%^&*()-_=+[{]}|;:,<.>/?";
	let now = +new Date();

	ctx.clearRect(0, 0, canvas.width, canvas.height);

	/*
	for (let i = 1; i < canvas.NX; ++i) {
		let c = random(i,129.092,281.9929 + now/1e14);
		if (c < 1/3) {
			c *= 3/1;
			ctx.fillStyle = rgb(hsv2rgb(c, (c * 10) % 1, 0.5));
			ctx.fillRect(x(i), 0, 1, canvas.height);
		}
	}
	for (let j = 1; j < canvas.NY; ++j) {
		let c = random(182.11,j,158.2 + now/1e14);
		if (c < 1/3) {
			c *= 3/1;
			ctx.fillStyle = rgb(hsv2rgb(c, (c * 10) % 1, 0.5));
			ctx.fillRect(0,y(j), canvas.width, 1);
		}
	}
	*/

	for (let i = 0; i < canvas.NX; ++i)
	for (let j = 0; j < canvas.NY; ++j) {
		let c = random(i,j,821.91 + now/1e15);
		if (c < 2/3) {
			c *= 3/2;
			// let v = ((i + j) % 20 < 10) ? 0.4 : 0.8;
			let v = Math.sin(now/-500 + (i + j) / 3) * 0.2 + 0.6;
			ctx.fillStyle = rgb(hsv2rgb(random(i,j,291.2),random(i,j,959.4), v));
			c = alphabet.charAt(Math.floor(alphabet.length * c));
			putc(c, i, j);
		}
	}

	WINDOW.draw();
}

window.addEventListener("resize", resize);
window.addEventListener("load", () => {
	resize();
	tick();
});

function tick() {
	window.requestAnimationFrame(tick);
	draw();
}

</script>